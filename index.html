<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C√≥digo do Lucro</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- CSS principal -->
  

  <!-- Tema adicional -->
  
</head>

<body>
  <!-- TOPO FIXO DO SISTEMA -->
<header class="topbar">
  <!-- TOPO PREMIUM - C√ìDIGO DO LUCRO -->
<header class="topbar">
  <div class="topbar-content">
    <div class="brand">
      <img src="logo-codigodolucro.svg" alt="Logo" class="topbar-logo">
      <h1>C√≥digo do Lucro</h1>
      <button id="themeToggle" class="theme-toggle" aria-label="Alternar tema">üåô</button>

    </div>

    <nav class="nav-tabs">
      <button class="tab-button active" data-tab="dashboard">Dashboard</button>
      <button class="tab-button" data-tab="faturamento">Faturamento</button>
      <button class="tab-button" data-tab="insumos">Insumos</button>
      <button class="tab-button" data-tab="ficha">Ficha T√©cnica</button>
      <button class="tab-button" data-tab="pv">PV</button>
      <button class="tab-button" data-tab="combos">Combos</button>
    </nav>
  </div>
</header>

<!-- √ÅREA PRINCIPAL -->
<main class="main-content">
  <section id="dashboard" class="tab-section active">
    <h2>üìä Dashboard</h2>
    <p>Bem-vindo ao painel principal do sistema C√≥digo do Lucro.</p>
  </section>

  <section id="faturamento" class="tab-section">
    <h2>üí∞ Faturamento</h2>
    <p>Resumo financeiro e metas da sua opera√ß√£o.</p>
  </section>

  <section id="insumos" class="tab-section">
    <h2>üßæ Insumos</h2>
    <p>Controle de custos e fichas de insumos.</p>
  </section>

  <section id="ficha" class="tab-section">
    <h2>üìã Ficha T√©cnica</h2>
    <p>Detalhes t√©cnicos dos seus produtos e receitas.</p>
  </section>

  <section id="pv" class="tab-section">
    <h2>üè™ PV</h2>
    <p>Gerencie pontos de venda e desempenho das lojas.</p>
  </section>

  <section id="combos" class="tab-section">
    <h2>üçî Combos</h2>
    <p>Monte e gerencie seus combos promocionais.</p>
  </section>
</main>
<section id="dashboard" class="tab-section active">
  <div class="dashboard-container">
    <h2>üìä Desempenho Geral</h2>

    <div class="cards-grid">
      <div class="card">
        <h3>CMV M√©dio</h3>
        <p id="cmvValor">R$ 0,00</p>
      </div>
      <div class="card">
        <h3>Lucro (%)</h3>
        <p id="lucroValor">0%</p>
      </div>
      <div class="card">
        <h3>PV Loja M√©dio</h3>
        <p id="pvValor">R$ 0,00</p>
      </div>
      <div class="card destaque">
        <h3>Faturamento M√™s</h3>
        <p id="faturamentoValor">R$ 0,00</p>
      </div>
    </div>

    <canvas id="graficoLucro" width="400" height="180"></canvas>
  </div>
</section>
</header>

  <!-- LAYOUT PRINCIPAL -->
  <div class="layout">
   
    <!-- CONTE√öDO PRINCIPAL -->
    <main class="main-content">
      <section class="dashboard" id="dashboard">
        <h1>Bem-vindo ao <span>C√≥digo do Lucro</span> üëã</h1>
        <p>Seu sistema de precifica√ß√£o inteligente e integrado.</p>
        <div class="dash-kpis">
          <div class="dash-card"><h3>CMV M√©dio</h3><p>R$ 4,22</p></div>
          <div class="dash-card"><h3>Lucro %</h3><p>20%</p></div>
          <div class="dash-card"><h3>PV Loja M√©dio</h3><p>R$ 10,32</p></div>
          <div class="dash-card"><h3>Faturamento</h3><p>R$ 12.450,00</p></div>
        </div>
      </section>
    </main>

  </div>
  <!-- fim layout -->
<!-- Bloco O ‚Äî Base de dados -->
<script src="dados.js"></script>


<!-- Firebase SDK + Firestore -->
<script type="module">
  console.log('[Firebase] Iniciando m√≥dulo...');

  import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
  import { getFirestore, collection, addDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: 'SUA_API_KEY',
    authDomain: 'lucro-facil-28aaf.firebaseapp.com',
    projectId: 'lucro-facil-28aaf',
    storageBucket: 'lucro-facil-28aaf.appspot.com',
    messagingSenderId: 'SEU_ID',
    appId: 'SEU_APP_ID'
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  console.log('[Firebase] Inicializado com sucesso.');

  // Fun√ß√£o de teste
  window.testeFirebase = async () => {
    try {
      const ref = await addDoc(collection(db, 'precos'), {
        nome: 'Combo Burger',
        valor: 29.90,
        criadoEm: new Date().toISOString()
      });
      console.log('[Firebase] Documento criado:', ref.id);
    } catch (e) {
      console.error('[Firebase] Erro ao salvar:', e);
    }
  };

  // Fun√ß√£o para salvar insumo
  window.salvarInsumoFirebase = async (insumo) => {
    try {
      await addDoc(collection(db, 'insumos'), insumo);
      console.log('[Firebase] Insumo salvo:', insumo);
    } catch (e) {
      console.error('[Firebase] Erro ao salvar insumo:', e);
    }
  };

  // Fun√ß√£o para salvar ficha t√©cnica
  window.salvarFichaFirebase = async (ficha) => {
    try {
      await addDoc(collection(db, 'fichas'), ficha);
      console.log('[Firebase] Ficha salva:', ficha);
    } catch (e) {
      console.error('[Firebase] Erro ao salvar ficha:', e);
    }
  };

  // Fun√ß√£o para salvar faturamento
  window.salvarFaturamentoFirebase = async (fat) => {
    try {
      await addDoc(collection(db, 'faturamento'), fat);
      console.log('[Firebase] Faturamento salvo:', fat);
    } catch (e) {
      console.error('[Firebase] Erro ao salvar faturamento:', e);
    }
  };
</script>

</body>
</html>
      
  <div class="sidebar-footer">
    v1.0 ‚Äî Sistema Premium Carreiro
  </div>
</aside>

  <header class="app-header">

  <header class="app-header">
    <!-- LOGO - arquivo separado -->
<div class="brand" style="display:flex;align-items:center;gap:12px;">
  <img src="logo-codigodolucro.svg" alt="C√≥digo do Lucro" style="width:48px;height:48px;border-radius:10px;">
  <div>
    <div style="font-weight:700;font-size:18px;color:#fff;line-height:1;">C√≥digo do Lucro</div>
    <div style="font-size:12px;color:rgba(255,255,255,0.9);margin-top:2px;">Sistema de Precifica√ß√£o Inteligente</div>
  </div>
</div>
  </header>

  <main class="app-main">
    <!-- DASHBOARD PREMIUM -->
<section class="dashboard" id="dashboard">
  <div class="dash-header">
    <h1>Bem-vindo ao <span>C√≥digo do Lucro</span> üëã</h1>
    <p>Veja abaixo um resumo r√°pido do desempenho da sua opera√ß√£o.</p>
  </div>

  <div class="dash-kpis">
    <div class="card">
  <h3>CMV M√©dio</h3>
  <p id="cmvMedio">R$ 0,00</p>
</div>
<div class="card">
  <h3>Lucro (%)</h3>
  <p id="lucroPercentual">0%</p>
</div>
<div class="card">
  <h3>PV Loja M√©dio</h3>
  <p id="pvMedio">R$ 0,00</p>
</div>
<div class="card destaque">
  <h3>Faturamento M√™s</h3>
  <p id="faturamentoMes">R$ 0,00</p>
</div>
  </div>

  <canvas id="dash_chart" width="400" height="160"></canvas>
</section>

    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Lojas</h2>
      </div>
      <ul id="listaLojas" class="lojas-list"></ul>
    </aside>

    <!-- DASHBOARD -->
      <section id="dashboard" class="tab-panel active">
        <div class="panel-header">
          <input id="nomeLoja" class="store-name" placeholder="Nome da loja"/>
          <button class="btn primary" onclick="salvarNome()">Salvar nome</button>
          <button class="btn" onclick="voltar()">Voltar</button>
        </div>
        <div class="cards">
          <article class="card">
            <h3>Resumo</h3>
            <p>Total de lojas: <strong id="totalLojas">0</strong></p>
            <p>√öltima atualiza√ß√£o: <strong id="ultimaAtualizacao">‚Äî</strong></p>
          </article>
          <article class="card">
            <h3>Margem</h3>
            <p>Margem m√©dia: <strong id="margemMedia">‚Äî</strong></p>
          </article>
        </div>
      </section>

      <!-- DNA -->
      <section id="dna" class="tab-panel">
        <h3>DNA</h3>
        <p>Cadastre custos fixos por m√™s (aluguel, sal√°rios, energia, g√°s, internet etc.). (em breve)</p>
      </section>

      <!-- FATURAMENTO -->
      <section id="faturamento" class="tab-panel">
       <!-- FATURAMENTO (RELAYOUT): START -->
<div class="fat-layout">
  <!-- COLUNA ESQUERDA ‚Äî PAR√ÇMETROS / FORM -->
  <div class="fat-left">
    <div class="card fat-card">
      <div class="fat-card-header">
        <h3>Faturamento ‚Äî Contexto</h3>
        <span class="fat-help">Selecione a loja e o m√™s para ver/editar os valores</span>
      </div>
      <div class="fat-field">
        <label class="lbl">Loja</label>
        <select id="fat_loja"></select>
      </div>
      <div class="fat-grid-2">
        <div class="fat-field">
          <label class="lbl">M√™s/Ano (refer√™ncia)</label>
          <input type="month" id="fat_mesano"/>
        </div>
        <div class="fat-field">
          <label class="lbl">Faturamento do m√™s (R$) <span class="muted">(se existir, carrega)</span></label>
          <input type="number" step="0.01" min="0" id="fat_valorMes" readonly/>
        </div>
      </div>
    </div>

    <div class="card fat-card">
      <div class="fat-card-header">
        <h3>Novo / Editar Faturamento</h3>
        <span class="fat-help">Informe o m√™s e o valor; as a√ß√µes abaixo criam/atualizam ou excluem</span>
      </div>
      <div class="fat-grid-2">
        <div class="fat-field">
          <label class="lbl">M√™s/Ano</label>
          <input type="month" id="fat_mesedit"/>
        </div>
        <div class="fat-field">
          <label class="lbl">Faturamento (R$)</label>
          <input type="number" step="0.01" min="0" id="fat_valoredit"/>
        </div>
      </div>
      <div class="fat-actions">
        <button class="btn primary" id="fat_btnSalvar">Salvar</button>
        <button class="btn" id="fat_btnNovo">Limpar</button>
        <button class="btn" id="fat_btnExcluir" disabled>Excluir</button>
      </div>
      <div class="muted" id="fat_status" style="margin-top:8px"></div>
    </div>

    <details class="card fat-card">
      <summary class="fat-card-header">
        <h3>Importar por colagem (CSV)</h3>
        <span class="fat-help">Formato: <code>ano,mes,faturamento</code> ‚Äî um por linha</span>
      </summary>
      <div class="fat-body">
        <textarea id="fat_csv" rows="5" placeholder="2025,09,18037.58&#10;2025,10,19220.00"></textarea>
        <div class="fat-actions" style="margin-top:6px">
          <button class="btn" id="fat_btnImp">Importar CSV</button>
          <button class="btn" id="fat_btnExp">Exportar CSV</button>
        </div>
      </div>
    </details>
  </div>

  <!-- COLUNA DIREITA ‚Äî KPI & TABELA -->
  <div class="fat-right">
    <div class="card fat-card fat-sticky">
      <div class="fat-card-header">
        <h3>Resumo (12 meses)</h3>
        <span class="fat-help">Baseado nos √∫ltimos 12 registros, do mais recente para tr√°s</span>
      </div>
      <div class="fat-kpis">
        <div class="kpi">
          <div class="kpi-label">Faturamento Bruto (12m)</div>
          <div class="kpi-value" id="fat_kpi_bruto12">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">M√©dia 12m</div>
          <div class="kpi-value" id="fat_kpi_media12">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">M√™s Selecionado</div>
          <div class="kpi-value" id="fat_kpi_mesSel">‚Äî</div>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:10px">
        <table class="pv-table">
          <thead>
            <tr>
              <th>M√™s/Ano</th>
              <th class="right">Faturamento (R$)</th>
              <th class="right">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="fat_tbody"></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px">
        Dica: edite diretamente via a√ß√µes da tabela ou preencha no formul√°rio ‚ÄúNovo/Editar‚Äù √† esquerda.
        O faturamento do m√™s √© usado no DNA (CF% = Custo Fixo √∑ Faturamento).
      </div>
    </div>
  </div>
</div>
<!-- FATURAMENTO (RELAYOUT): END -->
      </section>

      <!-- INSUMOS (CRUD + Import/Export + Busca + Duplicar) -->
      <section id="insumos" class="tab-panel">
        <div class="panel-header" style="justify-content:space-between; gap:12px;">
          <h3 style="margin:0">Insumos</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn ghost" onclick="exportarJSON()">Exportar JSON</button>
            <label class="btn ghost file-btn">
              Importar JSON
              <input type="file" accept="application/json" onchange="importarJSON(this)" hidden>
            </label>
            <label class="btn ghost file-btn">
              Importar CSV
              <input type="file" accept=".csv,text/csv" onchange="importarCSV(this)" hidden>
            </label>
            <button class="btn ghost" onclick="abrirModalColar()">Colar da planilha</button>
            <button class="btn" onclick="baixarModeloCSV()">Baixar modelo CSV</button>
          </div>
        </div>

        <!-- Formul√°rio de Insumos -->
        <form id="formInsumo" onsubmit="return salvarInsumo(event)" class="card" style="margin-bottom:12px;">
          <input type="hidden" id="insumoId">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px;">
            <div>
              <label>Nome do insumo</label>
              <input id="insumoNome" required placeholder="Ex.: P√£o com gergelim" class="store-name">
            </div>
            <div>
              <label>Unidade</label>
              <select id="insumoUnidade" class="store-name" required>
                <option value="un">un</option>
                <option value="g">g</option>
                <option value="ml">ml</option>
              </select>
            </div>
            <div>
              <label>Custo da compra (R$)</label>
              <input id="insumoCustoCompra" required inputmode="decimal" placeholder="Ex.: 25,50" class="store-name">
            </div>
            <div>
              <label>Quantidade na compra</label>
              <input id="insumoQtdCompra" required inputmode="decimal" placeholder="Ex.: 1000 (g/ml) ou 12 (un)" class="store-name">
            </div>
            <div>
              <label>Perda (%)</label>
              <input id="insumoPerda" inputmode="decimal" placeholder="0 a 100" class="store-name">
            </div>
          </div>
          <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="btn primary" type="submit">Salvar insumo</button>
            <button class="btn" type="button" onclick="limparFormInsumo()">Limpar</button>
          </div>
        </form>

        <!-- Busca -->
        <div class="card" style="margin-bottom:12px;">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input id="buscaInsumo" class="store-name" placeholder="Pesquisar por nome/unidade...">
            <small style="color:#b6add3">Dica: digite parte do nome (ex.: ‚Äúp√£o‚Äù, ‚Äúcheddar‚Äù).</small>
          </div>
        </div>

        <!-- Tabela de Insumos -->
        <div class="card table-wrap">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <strong>Lista de insumos</strong>
            <small style="color:#b6add3">Custo unit√°rio = custo compra √∑ qtd compra √∑ (1 - perda)</small>
          </div>
          <div class="table-scroll">
            <table class="table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th style="text-align:right;">Unid</th>
                  <th style="text-align:right;">Custo compra (R$)</th>
                  <th style="text-align:right;">Qtd compra</th>
                  <th style="text-align:right;">Perda (%)</th>
                  <th style="text-align:right;">Custo unit. (R$ / un-g-ml)</th>
                  <th style="width:220px;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tbodyInsumos"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- FICHA T√âCNICA (CRUD) -->
      <section id="ficha" class="tab-panel">
        <div class="panel-header" style="justify-content:space-between; gap:12px;">
          <h3 style="margin:0">Ficha T√©cnica</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" onclick="novaFicha()">+ Nova ficha</button>
          </div>
        </div>

        <!-- Form de Ficha -->
        <form id="formFicha" onsubmit="return salvarFicha(event)" class="card" style="margin-bottom:12px;">
          <input type="hidden" id="fichaId">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
            <div>
              <label>Nome da ficha</label>
              <input id="fichaNome" required placeholder="Ex.: Cheeseburger" class="store-name">
            </div>
            <div>
              <label>Rendimento (por√ß√µes)</label>
              <input id="fichaRendimento" required inputmode="decimal" value="1" class="store-name">
            </div>
            <div>
              <label>Custo total (R$)</label>
              <input id="fichaCustoTotal" disabled class="store-name" title="Calculado automaticamente">
            </div>
          </div>

          <hr style="border:0;border-top:1px solid var(--border); margin:12px 0">

          <!-- Adicionar item -->
          <div style="display:grid; grid-template-columns: 1fr 160px 140px; gap:10px; align-items:center;">
            <div>
              <label>Insumo</label>
              <input id="fItemInsumo" list="listaInsumosDatalist" placeholder="Digite e selecione..." class="store-name">
              <datalist id="listaInsumosDatalist"></datalist>
            </div>
            <div>
              <label>Quantidade</label>
              <input id="fItemQtd" inputmode="decimal" placeholder="Ex.: 90" class="store-name">
            </div>
            <div style="align-self:end;">
              <button class="btn" type="button" onclick="adicionarItemFicha()">Adicionar item</button>
            </div>
          </div>

          <div class="card table-wrap" style="margin-top:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
              <strong>Itens da ficha</strong>
              <small style="color:#b6add3">Custo item = custo unit√°rio do insumo √ó quantidade</small>
            </div>
            <div class="table-scroll">
              <table class="table">
                <thead>
                  <tr>
                    <th>Insumo</th>
                    <th style="text-align:right;">Unid</th>
                    <th style="text-align:right;">Qtd</th>
                    <th style="text-align:right;">Custo unit. (R$)</th>
                    <th style="text-align:right;">Custo item (R$)</th>
                    <th style="width:120px;">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="tbodyFichaItens"></tbody>
              </table>
            </div>
          </div>

          <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
            <button class="btn primary" type="submit">Salvar ficha</button>
            <button class="btn" type="button" onclick="limparFormFicha()">Limpar</button>
          </div>
        </form>

        <!-- Lista de Fichas -->
        <div class="card table-wrap">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <strong>Fichas cadastradas</strong>
            <input id="buscaFicha" class="store-name" placeholder="Buscar ficha por nome..." style="max-width:320px">
          </div>
          <div class="table-scroll">
            <table class="table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th style="text-align:right;">Rend.</th>
                  <th style="text-align:right;">Itens</th>
                  <th style="text-align:right;">Custo total (R$)</th>
                  <th style="width:220px;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tbodyFichas"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PV -->
      <!-- PV: START -->
<section class="tab-panel" id="pv">
  <!-- PV (RELAYOUT): START -->
  <!-- PV (RELAYOUT): START -->
<section class="tab-panel" id="pv">
  <!-- PV HEADER -->
<div class="pv-header">
  <div>
    <h2>Calculadora de Pre√ßo de Venda</h2>
    <small>Baseada na planilha de precifica√ß√£o Carreiro</small>
  </div>
  <button id="pv_toggleCompact" class="pv-btn">Modo Compacto</button>
</div>
  <!-- PV HEADER - C√≥digo do Lucro -->
<div class="pv-header">
  <div style="display:flex;align-items:center;gap:12px;">
    <img src="logo-codigodolucro.svg" alt="C√≥digo do Lucro" style="width:48px;height:48px;border-radius:8px;">
    <div>
      <h2 style="margin:0;color:#fff;">C√≥digo do Lucro</h2>
      <small style="color:rgba(255,255,255,0.92)">Calculadora de Pre√ßo & Intelig√™ncia de Margem</small>
    </div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button id="pv_toggleCompact" class="pv-btn">Modo Compacto</button>
  </div>
</div>
  <div class="pv-layout">

    <!-- COLUNA ESQUERDA -->
    <div class="pv-left">

      <!-- CONTEXTO -->
      <div class="pv-card">
        <h3>Contexto</h3>
        <label>Loja:</label>
        <input id="pv_loja" class="w-full" placeholder="Nome da loja" />
        <label>Ficha T√©cnica:</label>
        <input id="pv_ficha" class="w-full" placeholder="Nome do lanche" />
        <label>M√™s/Ano:</label>
        <input id="pv_mesano" type="month" class="w-full" />
        <label>CMV:</label>
        <input id="pv_cmv" type="number" step="0.0001" class="w-full" placeholder="Custo do lanche (R$)" />
      </div>

      <!-- DNA -->
      <details class="pv-card" open>
        <summary><strong>DNA do Neg√≥cio</strong></summary>
        <div class="pv-dna">
          <label>Faturamento M√™s (R$):</label>
          <input id="pv_fatMes" type="number" />
          <label>Custo Fixo M√™s (R$):</label>
          <input id="pv_cfMes" type="number" />
          <label>CF%:</label>
          <input id="pv_cfPct" type="number" step="0.01" placeholder="Ex: 25" />
          <label>Cart√µes (%):</label>
          <input id="pv_cartoesPct" type="number" step="0.01" />
          <label>Voucher (%):</label>
          <input id="pv_voucherPct" type="number" step="0.01" />
          <label>Imposto (%):</label>
          <input id="pv_impostoPct" type="number" step="0.01" />
          <label>Royalties (%):</label>
          <input id="pv_royaltyPct" type="number" step="0.01" />
          <label>Marketing (%):</label>
          <input id="pv_mktPct" type="number" step="0.01" />
          <label>Total DNA (%):</label>
          <input id="pv_dnaPct" type="number" step="0.01" readonly />
          <label>Lucro (%):</label>
          <input id="pv_lucroPct" type="number" step="0.01" />
        </div>
      </details>

      <!-- CANAIS -->
      <details class="pv-card" open>
        <summary><strong>Canais de Venda</strong></summary>
        <div class="pv-canais">
          <label>iFood (%):</label>
          <input id="pv_ifoodPct" type="number" step="0.01" />
          <label>Entrega iFood (R$):</label>
          <input id="pv_entregaIFR" type="number" step="0.01" />
          <label>CI iFood (R$):</label>
          <input id="pv_ciIFR" type="number" step="0.01" value="5" />
          <label>99Food (%):</label>
          <input id="pv_nfoodPct" type="number" step="0.01" value="12.1" />
          <label>Entrega 99 (R$):</label>
          <input id="pv_entrega99R" type="number" step="0.01" />
          <label>Arredondamento:</label>
          <select id="pv_roundRule">
            <option value="none">Nenhum</option>
            <option value=",99">Terminar em ,99</option>
            <option value=",90">Terminar em ,90</option>
            <option value="0.50">M√∫ltiplos de 0,50</option>
          </select>
        </div>
      </details>

      <!-- A√á√ïES -->
      <div class="pv-card">
        <h3>A√ß√µes</h3>
        <button id="pv_btnCalc" class="pv-btn w-full">Calcular PV</button>
        <button id="pv_btnPuxarMes" class="pv-btn w-full mt-2">Puxar M√™s</button>
        <button id="pv_btnSalvarPrefs" class="pv-btn w-full mt-2">Salvar Prefer√™ncias</button>
        <button id="pv_btnImpCF" class="pv-btn w-full mt-2">Importar CF</button>
        <button id="pv_btnImpFat" class="pv-btn w-full mt-2">Importar Faturamento</button>
      </div>

    </div>

    <!-- COLUNA DIREITA -->
    <div class="pv-right">

      <!-- KPIs -->
      <div class="pv-card">
        <h3>Resumo</h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-3">
          <div class="pv-kpi">
            <div class="pv-kpi-label">CMV</div>
            <div id="kpi_cmv" class="pv-kpi-value">--</div>
          </div>
          <div class="pv-kpi">
            <div class="pv-kpi-label">DNA</div>
            <div id="kpi_dna" class="pv-kpi-value">--</div>
          </div>
          <div class="pv-kpi">
            <div class="pv-kpi-label">Lucro</div>
            <div id="kpi_lucro" class="pv-kpi-value">--</div>
          </div>
          <div class="pv-kpi">
            <div class="pv-kpi-label">PV Loja</div>
            <div id="kpi_pvloja" class="pv-kpi-value">--</div>
          </div>
          <div class="pv-kpi">
            <div class="pv-kpi-label">PV iFood</div>
            <div id="kpi_ifood" class="pv-kpi-value">--</div>
          </div>
          <div class="pv-kpi">
            <div class="pv-kpi-label">PV iFood (CI)</div>
            <div id="kpi_ifoodci" class="pv-kpi-value">--</div>
          </div>
          <div class="pv-kpi">
            <div class="pv-kpi-label">PV 99Food</div>
            <div id="kpi_99" class="pv-kpi-value">--</div>
          </div>
        </div>
      </div>

      <!-- TABELA RESULTADOS -->
      <div class="pv-card mt-4">
        <h3>Tabela de Resultados</h3>
        <table class="pv-table">
          <thead>
            <tr>
              <th>Lanche</th>
              <th>CMV</th>
              <th>DNA%</th>
              <th>Lucro%</th>
              <th>PV Loja</th>
              <th>iFood</th>
              <th>iFood CI</th>
              <th>99Food</th>
            </tr>
          </thead>
          <tbody id="pv_tbody">
            <tr><td colspan="8" class="pv-muted text-center">Nenhum c√°lculo ainda.</td></tr>
          </tbody>
        </table>
        <div id="pv_status" class="pv-muted mt-2"></div>
      </div>

    </div>
  </div>
</section>
<!-- PV (RELAYOUT): END -->

</section>
<!-- PV: END -->

      <!-- COMBOS -->
      <section id="combos" class="tab-panel">
        <h3>Combos</h3>
        <p>(depois) Montagem de combos e sugest√£o de PV.</p>
      </section>
    </section>
  </main>

  <footer class="app-footer">
    <span>¬© Espa√ßo Carreiro Lanches</span>
  </footer>

  <!-- Modal de colar planilha -->
  <div id="maskColar" class="modal-mask">
    <div class="modal">
      <h4>Colar da planilha (Excel/Google Sheets)</h4>
      <div class="row">
        <small>Cole aqui linhas com <b>cabe√ßalho</b>. Separadores aceitos: TAB, ponto e v√≠rgula (;) ou v√≠rgula (,).</small>
      </div>
      <textarea id="textareaColar" placeholder="Exemplo:
Nome;Unidade;CustoCompra;QtdCompra;Perda
P√£o com gergelim;un;25,50;12;0
Carne bovina mo√≠da;g;36,00;1000;5
Cheddar fatiado;un;32,00;24;0"></textarea>
      <div class="row">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <label style="display:flex; gap:6px; align-items:center;">
            <input type="checkbox" id="chkSubstituir"> Substituir itens com mesmo <b>Nome</b> (case-insensitive)
          </label>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn primary" onclick="importarPorColagem()">Importar</button>
          <button class="btn" onclick="fecharModalColar()">Cancelar</button>
        </div>
      </div>
      <div class="row">
        <small>Campos reconhecidos (cabe√ßalho): <code>Nome</code>, <code>Unidade</code>, <code>CustoCompra</code>, <code>QtdCompra</code>, <code>Perda</code>.<br>
        Sin√¥nimos: Nome|Insumo ¬∑ Unidade|Unid ¬∑ Custo|ValorCompra|Preco|Pre√ßo ¬∑ Qtd|Quantidade ¬∑ Perda|Perdas|%Perda.</small>
      </div>
    </div>
  </div>

  <!-- Aviso caso abra no github.com (preview sem JS) -->
  <div id="warn" class="warning"></div>

  <script>
    (function(){
      /* ====== AVISO DE PREVIEW DO GITHUB ====== */
      const warn = document.getElementById('warn');
      if(location.host.includes('github.com')){
        warn.style.display = 'block';
        warn.innerHTML = '‚ö†Ô∏è Voc√™ est√° vendo a <b>pr√©-visualiza√ß√£o do GitHub (github.com)</b>. '
          + 'Abra o site publicado em https://github.io</a> para interatividade.';
      }

      /* ====== ESTADO (localStorage) ====== */
      const STORAGE_KEY = 'carreiro.precificacao.v1';
      function loadState(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : { lojas: [], lojaAtivaId: null, ultimaAtualizacao: null };
        }catch(e){ return { lojas: [], lojaAtivaId: null, ultimaAtualizacao: null }; }
      }
      function saveState(s){
        s.ultimaAtualizacao = new Date().toISOString();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      }
      let state = loadState();

      function uid(){ return (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)) }
      function getLojaAtiva(){ return state.lojas.find(l => l.id === state.lojaAtivaId) || null }
      function setLojaAtiva(id){ state.lojaAtivaId = id; saveState(state); render(); }
      function fmtData(iso){ return iso ? new Date(iso).toLocaleString('pt-BR') : '‚Äî' }

      /* ====== FUN√á√ïES GLOBAIS BASE ====== */
      window.novaloja = function(){
        const id = uid();
        state.lojas.push({ id, nome: `Loja ${state.lojas.length + 1}`, logo: null, dna:{}, faturamento:{}, insumos:[], fichas:[], pv:{}, combos:[] });
        state.lojaAtivaId = id; saveState(state); render();
      };
      window.duplicar = function(){
        const atual = getLojaAtiva();
        if(!atual){ alert('Nenhuma loja selecionada.'); return; }
        const id = uid();
        const clone = JSON.parse(JSON.stringify(atual));
        clone.id = id; clone.nome = `${atual.nome} (c√≥pia)`;
        state.lojas.push(clone); state.lojaAtivaId = id; saveState(state); render();
      };
      window.salvarNome = function(){
        const atual = getLojaAtiva();
        if(!atual){ alert('Nenhuma loja selecionada.'); return; }
        const input = document.getElementById('nomeLoja');
        if(!input){ alert('Campo de nome n√£o encontrado'); return; }
        const novo = input.value.trim();
        if(novo) atual.nome = novo;
        saveState(state); render();
      };
      window.voltar = function(){ window.showSection('dashboard'); };
      window.showSection = function(sectionId){
        document.querySelectorAll('.tab').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === sectionId));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === sectionId || p.id === `tab-${sectionId}`));
      };
      window.abrirLoja = function(id){ setLojaAtiva(id); };
      window.alterarLogo = function(input){
        const file = input?.files?.[0]; const atual = getLojaAtiva();
        if(!file || !atual) return;
        const reader = new FileReader();
        reader.onload = () => { atual.logo = reader.result; saveState(state); render(); };
        reader.readAsDataURL(file);
      };

      /* ====== UTILS NUM√âRICOS ====== */
      function toNumber(v){
        if(typeof v === 'number') return v;
        if(!v) return 0;
        return parseFloat(String(v).replace(/\./g,'').replace(',', '.')) || 0;
      }
      function money(v){ return (v ?? 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
      function normaliza(s){ return String(s||'').toLowerCase(); }

      /* ====== INSUMOS (CRUD + import) ====== */
      function getInsumos(){
        const loja = getLojaAtiva();
        return loja ? (loja.insumos || []) : [];
      }
      function setInsumos(arr){
        const loja = getLojaAtiva(); if(!loja) return;
        loja.insumos = arr; saveState(state);
      }
      function custoUnitario(ins){
        const perdaFator = 1 - (toNumber(ins.perda)/100);
        const efetivo = Math.max(0.000001, toNumber(ins.qtdCompra) * Math.max(0.000001, perdaFator));
        return toNumber(ins.custoCompra) / efetivo;
      }
      window.salvarInsumo = function(e){
        if(e) e.preventDefault();
        const loja = getLojaAtiva(); if(!loja){ alert('Nenhuma loja selecionada.'); return false; }
        const id = document.getElementById('insumoId').value || null;
        const nome = document.getElementById('insumoNome').value.trim();
        const unidade = document.getElementById('insumoUnidade').value;
        const custoCompra = toNumber(document.getElementById('insumoCustoCompra').value);
        const qtdCompra = toNumber(document.getElementById('insumoQtdCompra').value);
        const perda = Math.min(100, Math.max(0, toNumber(document.getElementById('insumoPerda').value||0)));
        if(!nome){ alert('Informe o nome.'); return false; }
        if(!qtdCompra || qtdCompra<=0){ alert('Quantidade da compra precisa ser > 0.'); return false; }
        const insumos = getInsumos();
        if(id){
          const i = insumos.findIndex(x => x.id === id);
          if(i>=0) insumos[i] = { ...insumos[i], nome, unidade, custoCompra, qtdCompra, perda };
        }else{
          insumos.push({ id: uid(), nome, unidade, custoCompra, qtdCompra, perda });
        }
        setInsumos(insumos); renderInsumos(); limparFormInsumo(); return false;
      };
      window.limparFormInsumo = function(){
        document.getElementById('insumoId').value = '';
        document.getElementById('insumoNome').value = '';
        document.getElementById('insumoUnidade').value = 'un';
        document.getElementById('insumoCustoCompra').value = '';
        document.getElementById('insumoQtdCompra').value = '';
        document.getElementById('insumoPerda').value = '';
      };
      window.editarInsumo = function(id){
        const ins = getInsumos().find(x => x.id === id); if(!ins) return;
        document.getElementById('insumoId').value = ins.id;
        document.getElementById('insumoNome').value = ins.nome;
        document.getElementById('insumoUnidade').value = ins.unidade;
        document.getElementById('insumoCustoCompra').value = String(ins.custoCompra).replace('.', ',');
        document.getElementById('insumoQtdCompra').value = String(ins.qtdCompra).replace('.', ',');
        document.getElementById('insumoPerda').value = String(ins.perda ?? 0).replace('.', ',');
        document.getElementById('insumoNome').focus();
        showSection('insumos');
      };
      window.removerInsumo = function(id){
        if(!confirm('Excluir este insumo?')) return;
        setInsumos(getInsumos().filter(x => x.id !== id));
        renderInsumos();
      };
      window.duplicarInsumo = function(id){
        const ins = getInsumos().find(x => x.id === id); if(!ins) return;
        const copia = { ...ins, id: uid(), nome: ins.nome + ' (c√≥pia)' };
        const arr = getInsumos(); arr.push(copia); setInsumos(arr); renderInsumos();
      };

      /* Busca insumos */
      let termoBusca = '';
      function aplicaBusca(arr){
        if(!termoBusca) return arr;
        const t = normaliza(termoBusca);
        return arr.filter(x => normaliza(x.nome).includes(t) || normaliza(x.unidade).includes(t));
      }

      /* Importa√ß√£o CSV/Colagem */
      function detectarSep(linha){
        if(linha.includes('\t')) return '\t';
        if((linha.match(/;/g)||[]).length >= (linha.match(/,/g)||[]).length) return ';';
        return ',';
      }
      function cabecalhoMap(headers){
        const map = {};
        headers.forEach((h, i)=>{
          const k = normaliza(h).replace(/\s+/g,'');
          if(/^(nome|insumo)$/.test(k)) map.nome = i;
          else if(/^(unidade|unid|un)$/.test(k)) map.unidade = i;
          else if(/^(custocompra|custo|valorcompra|preco|pre√ßo)$/.test(k)) map.custo = i;
          else if(/^(qtdcompra|qtd|quantidade)$/.test(k)) map.qtd = i;
          else if(/^(perda|perdas|%perda|perda%)$/.test(k)) map.perda = i;
        });
        return map;
      }
      function parseTabela(texto){
        const linhas = String(texto||'').trim().split(/\r?\n/).filter(l=>l.trim()!=='');
        if(linhas.length===0) return [];
        const sep = detectarSep(linhas[0]);
        const headers = linhas[0].split(sep).map(s=>s.trim());
        const map = cabecalhoMap(headers);
        const out = [];
        for(let i=1;i<linhas.length;i++){
          const cols = linhas[i].split(sep).map(s=>s.trim());
          const nome = cols[map.nome] || '';
          const unidade = (cols[map.unidade] || 'un').toLowerCase();
          const custoCompra = toNumber(cols[map.custo] || 0);
          const qtdCompra = toNumber(cols[map.qtd] || 0);
          const perda = toNumber(cols[map.perda] || 0);
          if(!nome || !qtdCompra) continue;
          out.push({ id: uid(), nome, unidade, custoCompra, qtdCompra, perda });
        }
        return out;
      }
      window.importarCSV = function(input){
        const file = input?.files?.[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{ const itens = parseTabela(reader.result);
          if(itens.length===0){ alert('Nada para importar. Verifique o cabe√ßalho e os separadores.'); return; }
          mesclarInsumos(itens, false);
        };
        reader.readAsText(file, 'utf-8');
      };
      const mask = document.getElementById('maskColar');
      const txtColar = document.getElementById('textareaColar');
      window.abrirModalColar = function(){ txtColar.value=''; mask.style.display='flex'; }
      window.fecharModalColar = function(){ mask.style.display='none'; }
      window.importarPorColagem = function(){
        const substituir = document.getElementById('chkSubstituir').checked;
        const itens = parseTabela(txtColar.value);
        if(itens.length===0){ alert('Nada para importar. Confira cabe√ßalho/valores.'); return; }
        mesclarInsumos(itens, substituir);
      };
      function mesclarInsumos(novos, substituir){
        const arr = getInsumos();
        if(substituir){
          novos.forEach(n=>{
            const i = arr.findIndex(a => normaliza(a.nome) === normaliza(n.nome));
            if(i>=0) arr[i] = { ...n, id: arr[i].id }; else arr.push(n);
          });
        }else{
          arr.push(...novos);
        }
        setInsumos(arr); renderInsumos(); fecharModalColar(); showSection('insumos'); alert(`Importados ${novos.length} insumos.`);
      }
      window.baixarModeloCSV = function(){
        const csv = [
          'Nome;Unidade;CustoCompra;QtdCompra;Perda',
          'P√£o com gergelim;un;25,50;12;0',
          'Carne bovina mo√≠da;g;36,00;1000;5',
          'Cheddar fatiado;un;32,00;24;0',
          'Bacon fatiado;g;45,00;1000;0',
          'Alface americano;g;6,00;500;10',
          'Cebola roxa;g;8,00;500;5',
          'Picles;g;18,00;1000;0',
          'Molho especial;ml;20,00;1000;0'
        ].join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'modelo-insumos.csv';
        document.body.appendChild(a); a.click(); a.remove();
      };

      /* ====== EXPORTAR/IMPORTAR JSON ====== */
      window.exportarJSON = function(){
        const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        const dt = new Date().toISOString().slice(0,10);
        a.href = URL.createObjectURL(blob);
        a.download = `precificacao-carreiro-backup-${dt}.json`;
        document.body.appendChild(a); a.click(); a.remove();
      };
      window.importarJSON = function(input){
        const file = input?.files?.[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const data = JSON.parse(reader.result);
            if(!data || typeof data !== 'object' || !Array.isArray(data.lojas)){ alert('Arquivo inv√°lido.'); return; }
            state = data; saveState(state); render(); showSection('insumos'); alert('Dados importados com sucesso!');
          }catch(e){ console.error(e); alert('Falha ao ler o JSON.'); }
        };
        reader.readAsText(file);
      };

      /* ====== FICHA T√âCNICA (CRUD) ====== */
      function getFichas(){
        const loja = getLojaAtiva(); return loja ? (loja.fichas || []) : [];
      }
      function setFichas(arr){
        const loja = getLojaAtiva(); if(!loja) return; loja.fichas = arr; saveState(state);
      }
      function getInsumoByNameCaseInsensitive(nome){
        const t = normaliza(nome);
        return getInsumos().find(i => normaliza(i.nome) === t) || null;
      }
      function custoItem(ins, qtd){ return custoUnitario(ins) * toNumber(qtd); }
      function custoTotalFicha(itens){
        return itens.reduce((acc, it)=>{
          const ins = getInsumoById(it.insumoId); if(!ins) return acc;
          return acc + custoItem(ins, it.qtd);
        }, 0);
      }
      function getInsumoById(id){ return getInsumos().find(x => x.id === id) || null; }

      /* Form de Ficha (estado no DOM) */
      window.novaFicha = function(){
        limparFormFicha(); showSection('ficha'); document.getElementById('fichaNome').focus();
      };
      window.limparFormFicha = function(){
        document.getElementById('fichaId').value = '';
        document.getElementById('fichaNome').value = '';
        document.getElementById('fichaRendimento').value = '1';
        document.getElementById('fichaCustoTotal').value = '';
        document.getElementById('fItemInsumo').value = '';
        document.getElementById('fItemQtd').value = '';
        document.getElementById('tbodyFichaItens').innerHTML = '';
        atualizarCustoTotalForm();
      };
      function adicionarLinhaItem(insumoId, nome, unidade, qtd){
        const tbody = document.getElementById('tbodyFichaItens');
        const ins = getInsumoById(insumoId); if(!ins) return;
        const custoU = custoUnitario(ins);
        const custoI = custoU * toNumber(qtd);
        const tr = document.createElement('tr');
        tr.dataset.insumoId = insumoId;
        tr.dataset.qtd = String(qtd);
        tr.innerHTML = `
          <td>${nome}</td>
          <td style="text-align:right">${unidade}</td>
          <td style="text-align:right">${toNumber(qtd).toLocaleString('pt-BR')}</td>
          <td style="text-align:right">${money(custoU)}</td>
          <td style="text-align:right">${money(custoI)}</td>
          <td>
            <div class="actions">
              <button class="btn" type="button" onclick="editarItemFicha(this)">Editar</button>
              <button class="btn" type="button" onclick="removerItemFicha(this)">Remover</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
        atualizarCustoTotalForm();
      }
      function atualizarCustoTotalForm(){
        const tbody = document.getElementById('tbodyFichaItens');
        let total = 0;
        [...tbody.querySelectorAll('tr')].forEach(tr=>{
          const ins = getInsumoById(tr.dataset.insumoId); if(!ins) return;
          total += custoItem(ins, toNumber(tr.dataset.qtd));
        });
        document.getElementById('fichaCustoTotal').value = money(total);
      }
      window.adicionarItemFicha = function(){
        const nome = document.getElementById('fItemInsumo').value.trim();
        const qtd = toNumber(document.getElementById('fItemQtd').value);
        if(!nome){ alert('Informe o nome do insumo.'); return; }
        if(!qtd || qtd<=0){ alert('Informe uma quantidade > 0.'); return; }
        const ins = getInsumoByNameCaseInsensitive(nome);
        if(!ins){ alert('Insumo n√£o encontrado. Use um nome igual ao cadastrado em Insumos.'); return; }
        adicionarLinhaItem(ins.id, ins.nome, ins.unidade, qtd);
        document.getElementById('fItemInsumo').value = ''; document.getElementById('fItemQtd').value = '';
      };
      window.removerItemFicha = function(btn){
        const tr = btn.closest('tr'); tr.remove(); atualizarCustoTotalForm();
      };
      window.editarItemFicha = function(btn){
        const tr = btn.closest('tr');
        const ins = getInsumoById(tr.dataset.insumoId); if(!ins) return;
        document.getElementById('fItemInsumo').value = ins.nome;
        document.getElementById('fItemQtd').value = tr.dataset.qtd;
        tr.remove(); atualizarCustoTotalForm();
      };

      window.salvarFicha = function(e){
        if(e) e.preventDefault();
        const id = document.getElementById('fichaId').value || null;
        const nome = document.getElementById('fichaNome').value.trim();
        const rendimento = Math.max(1, toNumber(document.getElementById('fichaRendimento').value || 1));
        if(!nome){ alert('Informe o nome da ficha.'); return false; }
        const itens = [];
        document.querySelectorAll('#tbodyFichaItens tr').forEach(tr=>{
          itens.push({ insumoId: tr.dataset.insumoId, qtd: toNumber(tr.dataset.qtd) });
        });
        if(itens.length===0){ if(!confirm('A ficha est√° sem itens. Deseja salvar assim mesmo?')) return false; }
        const fichas = getFichas();
        if(id){
          const i = fichas.findIndex(f => f.id === id);
          if(i>=0) fichas[i] = { ...fichas[i], nome, rendimento, itens };
        }else{
          fichas.push({ id: uid(), nome, rendimento, itens });
        }
        setFichas(fichas); renderFichas(); limparFormFicha(); alert('Ficha salva!');
        return false;
      };

      window.editarFicha = function(id){
        const f = getFichas().find(x => x.id === id); if(!f) return;
        limparFormFicha();
        document.getElementById('fichaId').value = f.id;
        document.getElementById('fichaNome').value = f.nome;
        document.getElementById('fichaRendimento').value = f.rendimento ?? 1;
        // preencher itens
        f.itens?.forEach(it=>{
          const ins = getInsumoById(it.insumoId);
          if(ins) adicionarLinhaItem(it.insumoId, ins.nome, ins.unidade, it.qtd);
        });
        showSection('ficha');
      };

      window.removerFicha = function(id){
        if(!confirm('Excluir esta ficha t√©cnica?')) return;
        setFichas(getFichas().filter(x => x.id !== id));
        renderFichas();
      };

      window.duplicarFicha = function(id){
        const f = getFichas().find(x => x.id === id); if(!f) return;
        const copia = { ...f, id: uid(), nome: f.nome + ' (c√≥pia)' };
        const arr = getFichas(); arr.push(copia); setFichas(arr); renderFichas();
      };

      function calcCustoTotalFichaObj(f){
        const itens = f.itens || [];
        return itens.reduce((acc, it)=>{
          const ins = getInsumoById(it.insumoId); if(!ins) return acc;
          return acc + custoItem(ins, toNumber(it.qtd));
        }, 0);
      }

      /* ====== RENDER ====== */
      function popularDatalistInsumos(){
        const dl = document.getElementById('listaInsumosDatalist'); if(!dl) return;
        dl.innerHTML = '';
        getInsumos().forEach(i=>{
          const opt = document.createElement('option');
          opt.value = i.nome; dl.appendChild(opt);
        });
      }

      function render(){
        // Lojas
        const ul = document.getElementById('listaLojas');
        if(ul){
          ul.innerHTML = '';
          state.lojas.forEach(l=>{
            const li = document.createElement('li');
            li.className = l.id === state.lojaAtivaId ? 'active' : '';
            li.innerHTML = `<span>${l.nome}</span>
              <span class="loja-actions"><button class="btn" onclick="abrirLoja('${l.id}')">Abrir</button></span>`;
            ul.appendChild(li);
          });
        }
        // KPIs
        const total = document.getElementById('totalLojas'); if(total) total.textContent = state.lojas.length;
        const ultima = document.getElementById('ultimaAtualizacao'); if(ultima) ultima.textContent = fmtData(state.ultimaAtualizacao);

        // Nome/Logo
        const loja = getLojaAtiva();
        const nomeInput = document.getElementById('nomeLoja'); if(nomeInput) nomeInput.value = loja?.nome || '';
        const logoEl = document.querySelector('.logo'); if(logoEl && loja?.logo) logoEl.src = loja.logo;

        // Busca Insumos
        const busca = document.getElementById('buscaInsumo');
        if(busca && !busca._wired){
          busca._wired = true;
          busca.addEventListener('input', ()=>{ termoBusca = busca.value; renderInsumos(); });
        }

        // Busca Fichas
        const buscaF = document.getElementById('buscaFicha');
        if(buscaF && !buscaF._wired){
          buscaF._wired = true;
          buscaF.addEventListener('input', ()=> renderFichas());
        }

        renderInsumos();
        renderFichas();
        popularDatalistInsumos();
        atualizarCustoTotalForm();
      }

      window.renderInsumos = function(){
        const tbody = document.getElementById('tbodyInsumos'); if(!tbody) return;
        const arr = aplicaBusca(getInsumos());
        tbody.innerHTML = '';
        arr.forEach(ins => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${ins.nome}</td>
            <td style="text-align:right">${ins.unidade}</td>
            <td style="text-align:right">${money(ins.custoCompra)}</td>
            <td style="text-align:right">${(ins.qtdCompra ?? 0).toLocaleString('pt-BR')}</td>
            <td style="text-align:right">${(ins.perda ?? 0).toLocaleString('pt-BR')}%</td>
            <td style="text-align:right">${money(custoUnitario(ins))}</td>
            <td>
              <div class="actions">
                <button class="btn" onclick="editarInsumo('${ins.id}')">Editar</button>
                <button class="btn" onclick="duplicarInsumo('${ins.id}')">Duplicar</button>
                <button class="btn" onclick="removerInsumo('${ins.id}')">Excluir</button>
              </div>
            </td>`;
          tbody.appendChild(tr);
        });
      };

      function renderFichas(){
        const tbody = document.getElementById('tbodyFichas'); if(!tbody) return;
        const termo = normaliza(document.getElementById('buscaFicha')?.value || '');
        const arr = getFichas().filter(f => !termo || normaliza(f.nome).includes(termo));
        tbody.innerHTML = '';
        arr.forEach(f=>{
          const total = calcCustoTotalFichaObj(f);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${f.nome}</td>
            <td style="text-align:right">${(f.rendimento ?? 1)}</td>
            <td style="text-align:right">${(f.itens?.length || 0)}</td>
            <td style="text-align:right">${money(total)}</td>
            <td>
              <div class="actions">
                <button class="btn" onclick="editarFicha('${f.id}')">Editar</button>
                <button class="btn" onclick="duplicarFicha('${f.id}')">Duplicar</button>
                <button class="btn" onclick="removerFicha('${f.id}')">Excluir</button>
              </div>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      document.addEventListener('DOMContentLoaded', ()=>{
        if(state.lojas.length === 0){
          const id = uid();
          state.lojas.push({ id, nome: 'Loja 1', logo: null, dna:{}, faturamento:{}, insumos:[], fichas:[], pv:{}, combos:[] });
          state.lojaAtivaId = id; saveState(state);
        }else{
          if(!getLojaAtiva()){ state.lojaAtivaId = state.lojas[0].id; saveState(state); }
        }
        // Tabs com listener (al√©m do onclick)
        document.querySelectorAll('.tab').forEach(btn=>{
          btn.addEventListener('click', ()=> window.showSection(btn.dataset.tab));
        });
        render();
      });
    })();
  </script>

<!-- Conte√∫do do seu app -->
...
<!-- Firebase SDK + Firestore -->
<script type="module">
  
<!-- Seu c√≥digo atual -->
<script>
  // ... c√≥digo do seu app ...
</script>

<!-- Substitua pelo novo bloco do Firebase -->
<script type="module">
  console.log("[Firebase] Iniciando m√≥dulo...");

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "lucro-facil-28aaf.firebaseapp.com",
    projectId: "lucro-facil-28aaf",
    storageBucket: "lucro-facil-28aaf.appspot.com",
    messagingSenderId: "SEU_ID",
    appId: "SEU_APP_ID"
  };

  try {
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    console.log("[Firebase] Inicializado com sucesso.");

    window.testeFirebase = async () => {
      try {
        const ref = await addDoc(collection(db, "precos"), {
          nome: "Combo Burger",
          valor: 29.90,
          criadoEm: new Date().toISOString()
        });
        console.log("[Firebase] Documento criado:", ref.id);
      } catch (e) {
        console.error("[Firebase] Erro ao salvar:", e);
      }
    };
  } catch (err) {
    console.error("[Firebase] Falha ao inicializar:", err);
  }
</script>

<!-- Firebase SDK + Firestore -->
<script type="module">
  console.log('[Firebase] Iniciando m√≥dulo...');

  import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
  import { getFirestore, collection, addDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: 'SUA_API_KEY',
    authDomain: 'lucro-facil-28aaf.firebaseapp.com',
    projectId: 'lucro-facil-28aaf',
    storageBucket: 'lucro-facil-28aaf.appspot.com',
    messagingSenderId: 'SEU_ID',
    appId: 'SEU_APP_ID'
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  console.log('[Firebase] Inicializado com sucesso.');

  // Fun√ß√£o de teste
  window.testeFirebase = async () => {
    try {
      const ref = await addDoc(collection(db, 'precos'), {
        nome: 'Combo Burger',
        valor: 29.90,
        criadoEm: new Date().toISOString()
      });
      console.log('[Firebase] Documento criado:', ref.id);
    } catch (e) {
      console.error('[Firebase] Erro ao salvar:', e);
    }
  };

  // Fun√ß√£o para salvar insumo
  window.salvarInsumoFirebase = async (insumo) => {
    try {
      await addDoc(collection(db, 'insumos'), insumo);
      console.log('[Firebase] Insumo salvo:', insumo);
    } catch (e) {
      console.error('[Firebase] Erro ao salvar insumo:', e);
    }
  };

  // Fun√ß√£o para salvar ficha t√©cnica
  window.salvarFichaFirebase = async (ficha) => {
    try {
      await addDoc(collection(db, 'fichas'), ficha);
      console.log('[Firebase] Ficha salva:', ficha);
    } catch (e) {
      console.error('[Firebase] Erro ao salvar ficha:', e);
    }
  };

  // Fun√ß√£o para salvar faturamento
  window.salvarFaturamentoFirebase = async (fat) => {
    try {
      await addDoc(collection(db, 'faturamento'), fat);
      console.log('[Firebase] Faturamento salvo:', fat);
    } catch (e) {
      console.error('[Firebase] Erro ao salvar faturamento:', e);
    }
  };
</script>

</body>
</html>

