<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PV ‚Äî Pre√ßo de Venda (Carreiro)</title>
<style>
  :root{--bg:#0f1220;--card:#171a2b;--mut:#98a2b3;--txt:#e6e7ee;--pri:#7c5cff;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--line:#23263a}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;gap:10px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-weight:900;font-size:18px}
  .sp{flex:1}
  .btn{background:var(--pri);color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer;text-decoration:none}
  .btn.ghost{background:#243055}
  main{max-width:1150px;margin:18px auto;padding:0 14px 110px}
  .grid{display:grid;gap:14px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  label{display:block;font-size:12px;color:var(--mut);margin-bottom:6px}
  input,select,textarea{width:100%;background:#0e1120;color:var(--txt);border:1px solid #2a2e45;border-radius:10px;padding:9px 10px;outline:none}
  input[readonly]{opacity:.85}
  .title{font-weight:800;letter-spacing:.06em;font-size:12px;color:#c7c9d9;text-transform:uppercase;margin-bottom:6px}
  .mini{font-size:12px;color:var(--mut)}
  table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #252941;font-size:14px}
  th{text-align:left;color:#cbd5e1} .right{text-align:right}
  .footer{position:fixed;left:0;right:0;bottom:0;background:rgba(15,18,32,.9);backdrop-filter:blur(6px);border-top:1px solid var(--line);padding:10px 14px;display:flex;gap:10px;align-items:center}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0f142a;color:#cbd5e1;font-size:12px}
</style>
</head>
<body>
<header>
  <h1>üí∞ PV ‚Äî Pre√ßo de Venda</h1>
  <span class="pill">Espelha sua planilha ‚Ä¢ iFood / iFood CI / 99Food</span>
  <div class="sp"></div>
  ./index.html‚Üê Voltar</a>
</header>

<main>
  <div class="grid g3">
    <!-- CONTEXTO -->
    <div class="card">
      <div class="title">Contexto</div>
      <label>Loja</label>
      <select id="loja"></select>

      <label style="margin-top:10px">Ficha T√©cnica</label>
      <select id="ficha"></select>

      <div class="grid g2" style="margin-top:10px">
        <div>
          <label>M√™s/Ano</label>
          <input type="month" id="mesano"/>
        </div>
        <div>
          <label>CMV + Embalagem (R$) <span class="mini">(auto da Ficha)</span></label>
          <input id="cmv" type="number" step="0.0001" min="0" readonly/>
        </div>
      </div>
    </div>

    <!-- DNA PERCENTUAL -->
    <div class="card">
      <div class="title">DNA por Percentual (igual √† planilha)</div>
      <div class="grid g2">
        <div>
          <label>Faturamento do m√™s (R$)</label>
          <input id="fatMes" type="number" step="0.01" min="0"/>
        </div>
        <div>
          <label>Total Custo Fixo do m√™s (R$)</label>
          <input id="cfMes" type="number" step="0.01" min="0"/>
        </div>
      </div>
      <div class="grid g3" style="margin-top:8px">
        <div>
          <label>Custo Fixo (%) <span class="mini">(auto)</span></label>
          <input id="cfPct" type="number" step="0.0001" min="0" readonly/>
        </div>
        <div>
          <label>M√©dia Cart√µes (%)</label>
          <input id="cartoesPct" type="number" step="0.01" min="0" value="3.64"/>
        </div>
        <div>
          <label>Voucher (%)</label>
          <input id="voucherPct" type="number" step="0.01" min="0" value="7.99"/>
        </div>
      </div>
      <div class="grid g3" style="margin-top:8px">
        <div>
          <label>Imposto (%)</label>
          <input id="impostoPct" type="number" step="0.01" min="0" value="0"/>
        </div>
        <div>
          <label>Royalties (%)</label>
          <input id="royaltyPct" type="number" step="0.01" min="0" value="0"/>
        </div>
        <div>
          <label>Marketing (%)</label>
          <input id="mktPct" type="number" step="0.01" min="0" value="0"/>
        </div>
      </div>
      <div class="grid g2" style="margin-top:8px">
        <div>
          <label>DNA Total (%) <span class="mini">(auto)</span></label>
          <input id="dnaPct" type="number" step="0.0001" min="0" readonly/>
        </div>
        <div>
          <label>Lucro alvo (%)</label>
          <input id="lucroPct" type="number" step="0.01" min="0" value="20"/>
        </div>
      </div>

      <details style="margin-top:8px">
        <summary class="mini">Comparativo: Rateio por por√ß√£o</summary>
        <div class="grid g3" style="margin-top:8px">
          <div><label>Por√ß√µes no m√™s</label><input id="porcoesMes" type="number" min="0" step="1"/></div>
          <div><label>DNA Total (R$/m√™s)</label><input id="dnaReaisMes" type="number" min="0" step="0.01"/></div>
          <div><label>DNA por por√ß√£o (R$)</label><input id="dnaPorcao" type="number" min="0" step="0.01" readonly/></div>
        </div>
      </details>
    </div>

    <!-- CANAIS -->
    <div class="card">
      <div class="title">Canais & Prefer√™ncias (tudo edit√°vel)</div>
      <div class="grid g3">
        <div>
          <label>iFood (%)</label>
          <input id="ifoodPct" type="number" step="0.01" min="0" value="17"/>
        </div>
        <div>
          <label>Entrega iFood (R$)</label>
          <input id="entregaIFR" type="number" step="0.01" min="0" value="9"/>
        </div>
        <div>
          <label>CI (R$) ‚Äî Invest. da Loja</label>
          <input id="ciIFR" type="number" step="0.01" value="5"/>
        </div>
      </div>
      <div class="grid g3" style="margin-top:8px">
        <div>
          <label>99Food (%)</label>
          <input id="nfoodPct" type="number" step="0.01" min="0" value="12.1"/>
        </div>
        <div>
          <label>Entrega 99Food (R$)</label>
          <input id="entrega99R" type="number" step="0.01" min="0" value="0"/>
        </div>
        <div>
          <label>Arredondamento</label>
          <select id="roundRule">
            <option value="none">Sem arredondamento</option>
            <option value="99">Terminar em ,99</option>
            <option value="90">Terminar em ,90</option>
            <option value="0.50">M√∫ltiplos de 0,50</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="btnCalc">Calcular</button>
        <button class="btn ghost" id="btnPuxarMes">Puxar CF/Faturamento do m√™s</button>
        <button class="btn ghost" id="btnSalvarPrefs">Salvar como padr√£o da loja</button>
      </div>
      <div class="mini" style="margin-top:6px">
        Dica: voc√™ pode colocar valores negativos em CI (R$) se, no futuro, quiser simular desconto/subs√≠dio direto no PV.
      </div>
    </div>
  </div>

  <!-- RESULTADOS -->
  <div class="card" style="margin-top:14px">
    <div class="title">Resultados</div>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th class="right">CMV (R$)</th>
          <th class="right">DNA% + Lucro%</th>
          <th class="right">PV Loja</th>
          <th class="right">PV iFood</th>
          <th class="right">PV iFood (CI)</th>
          <th class="right">PV 99Food</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="mini" style="margin-top:6px">
      F√≥rmulas: PV Loja = CMV / (1 ‚àí DNA% ‚àí Lucro%). PV iFood = (PV Loja + Entrega) / (1 ‚àí iFood%). PV iFood (CI) = (PV Loja + Entrega + CI) / (1 ‚àí iFood%). PV 99Food = (PV Loja + Entrega 99) / (1 ‚àí 99Food%).
    </div>
  </div>

  <!-- IMPORTADORES -->
  <details class="card" style="margin-top:14px">
    <summary><b>Importar Custo Fixo & Faturamento por colagem (CSV)</b></summary>
    <div class="grid g2" style="margin-top:8px">
      <div>
        <label>CF do m√™s ‚Äî formato: <code>ano,mes,totalCF</code></label>
        <textarea id="csvCF" rows="6" placeholder="2025,09,4951.12"></textarea>
        <button class="btn ghost" id="btnImpCF" style="margin-top:8px;">Importar CF</button>
      </div>
      <div>
        <label>Faturamento do m√™s ‚Äî formato: <code>ano,mes,faturamento</code></label>
        <textarea id="csvFat" rows="6" placeholder="2025,09,18037.58"></textarea>
        <button class="btn ghost" id="btnImpFat" style="margin-top:8px;">Importar Faturamento</button>
      </div>
    </div>
  </details>
</main>

<div class="footer">
  <span class="mini">Estado salvo no <code>localStorage</code>. Este arquivo n√£o altera seu <code>index.html</code>.</span>
  <div class="sp"></div>
  <span id="status" class="mini"></span>
</div>

<script>
/* ======== Estado & util ======== */
const STORAGE_KEYS = { state:['precificacaoState','carreiroState','pricingState'], ctx:'pv_context' };
const $ = s => document.querySelector(s);
const money = v => isFinite(v)? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '‚Äî';
const pctfmt = v => isFinite(v)? (v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})+'%' : '‚Äî';
const setStatus = t => { $('#status').textContent=t||''; setTimeout(()=>$('#status').textContent='',3000); };

function loadState(){
  for(const k of STORAGE_KEYS.state){
    const raw = localStorage.getItem(k);
    if(raw){ try{ const obj=JSON.parse(raw); obj.__key=k; return obj; }catch(e){} }
  }
  return null;
}
function saveState(s){ const k=s?.__key||STORAGE_KEYS.state[0]; const c={...s}; delete c.__key; localStorage.setItem(k, JSON.stringify(c)); }
function loadCtx(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEYS.ctx)||'{}')}catch(e){return{}} }
function saveCtx(o){ localStorage.setItem(STORAGE_KEYS.ctx, JSON.stringify(o||{})); }
function parseMonth(){ if(!$('#mesano').value) return null; const [y,m] = $('#mesano').value.split('-').map(n=>parseInt(n,10)); return {ano:y,mes:m}; }
function parseCSV(t){ return t.trim().split(/\r?\n/).map(l=>l.split(',').map(s=>s.trim())); }

let app = loadState();
if(!app){
  // fallback m√≠nimo (apenas para teste r√°pido)
  app = { lojas:[{ id:'lojax', nome:'Loja Demo',
    fichas:[{id:'carreirinho',nome:'CARREIRINHO',custoTotal:4.222658250449939}],
    dna:[{ano:2025,mes:9,totalFixosMes:4951.12}],
    faturamento:[{ano:2025,mes:9,faturamento:18037.58}],
    variaveis:{ prefs:{margemAlvoPercent:20,regraArred:'none'}, taxaMarketplacePercent:17, entregaReais:9 }
  }]};
  app.__key = STORAGE_KEYS.state[0]; saveState(app);
}

function getLoja(){ const id=$('#loja').value; return (app.lojas||[]).find(l=>l.id===id) || app.lojas?.[0]; }

/* ======== UI init ======== */
function initLojaSelect(){
  const sel=$('#loja'); sel.innerHTML='';
  (app.lojas||[]).forEach(l=>{ const o=document.createElement('option'); o.value=l.id; o.textContent=l.nome||l.id; sel.appendChild(o); });
  const ctx=loadCtx(); if(ctx?.lojaId && (app.lojas||[]).some(l=>l.id===ctx.lojaId)) sel.value = ctx.lojaId;
  sel.addEventListener('change', ()=>{ saveCtx({lojaId: sel.value}); initFichas(); });
}
function initFichas(){
  const loja=getLoja(); const fs=loja?.fichas||[]; const sel=$('#ficha'); sel.innerHTML='';
  fs.forEach(f=>{ const o=document.createElement('option'); o.value=f.id; o.textContent=f.nome||f.id; sel.appendChild(o); });
  updateCMV();
}
function updateCMV(){
  const loja=getLoja(); const fId=$('#ficha').value; const ficha=(loja?.fichas||[]).find(x=>x.id===fId);
  let custo = Number(ficha?.custoTotal ?? 0);
  if(!ficha?.custoTotal && ficha?.itens && loja?.insumos){
    const map = new Map((loja.insumos||[]).map(i=>[i.id,i]));
    custo = 0;
    for(const it of (ficha.itens||[])){
      const ins = map.get(it.insumoId); if(!ins) continue;
      const custoCompra=Number(ins.custoCompra||0), qtdCompra=Number(ins.qtdCompra||1), perda=(Number(ins.perdaPercent||ins.perda||0)/100);
      const unit = qtdCompra>0 ? (custoCompra/qtdCompra)/(1-perda) : 0;
      custo += unit * Number(it.qtd||it.quantidade||0);
    }
  }
  $('#cmv').value = (Math.round(custo*1e6)/1e6) || 0;
}

/* ======== DNA % ======== */
function puxarMes(){
  const loja=getLoja(); const mm=parseMonth(); if(!mm) return;
  const cf=(loja?.dna||[]).find(d=>d.ano===mm.ano&&d.mes===mm.mes);
  const fat=(loja?.faturamento||[]).find(f=>f.ano===mm.ano&&f.mes===mm.mes);
  if(cf) $('#cfMes').value = Number(cf.totalFixosMes ?? cf.total ?? 0);
  if(fat) $('#fatMes').value = Number(fat.faturamento ?? fat.receitaBruta ?? 0);
  calcCFPct(); setStatus('Valores do m√™s carregados.');
}
function calcCFPct(){ const cf=Number($('#cfMes').value||0), fat=Number($('#fatMes').value||0); $('#cfPct').value = fat>0? (cf/fat*100).toFixed(6) : ''; calcDNAPct(); }
function calcDNAPct(){
  const cf=Number($('#cfPct').value||0), c=Number($('#cartoesPct').value||0), v=Number($('#voucherPct').value||0), i=Number($('#impostoPct').value||0), r=Number($('#royaltyPct').value||0), m=Number($('#mktPct').value||0);
  $('#dnaPct').value = (cf + c + v + i + r + m).toFixed(6);
}
function calcRateio(){ const por=Number($('#porcoesMes').value||0), dn=Number($('#dnaReaisMes').value||0); $('#dnaPorcao').value = por>0 ? (dn/por).toFixed(2) : ''; }

/* ======== Arredondamento ======== */
function ceilRule(valor, regra){
  const cents = v=>Math.round(v*100)/100, ceilTo=(v,m)=>Math.ceil(v/m)*m;
  if(!isFinite(valor)) return NaN;
  switch(regra){
    case '99':{ const i=Math.floor(valor), cand=i+0.99; return cents(cand>=valor?cand:i+1+0.99); }
    case '90':{ const i=Math.floor(valor), cand=i+0.90; return cents(cand>=valor?cand:i+1+0.90); }
    case '0.50': return cents(ceilTo(valor,0.50));
    default: return cents(valor);
  }
}

/* ======== C√°lculos PV ======== */
function calcular(){
  calcCFPct(); calcDNAPct();

  const cmv = Number($('#cmv').value||0);
  const dna = Number($('#dnaPct').value||0)/100;
  const lucro = Number($('#lucroPct').value||0)/100;

  const ifood = Number($('#ifoodPct').value||0)/100;
  const entIF = Number($('#entregaIFR').value||0);
  const ciIF  = Number($('#ciIFR').value||0);

  const nfood = Number($('#nfoodPct').value||0)/100;
  const ent99 = Number($('#entrega99R').value||0);

  const denom = 1 - dna - lucro;
  const pvLoja = (cmv>0 && denom>0) ? (cmv/denom) : NaN;

  const pvIFood     = isFinite(pvLoja) && (1-ifood)>0 ? ((pvLoja + entIF)      / (1 - ifood)) : NaN;
  const pvIFood_CI  = isFinite(pvLoja) && (1-ifood)>0 ? ((pvLoja + entIF + ciIF) / (1 - ifood)) : NaN;
  const pv99Food    = isFinite(pvLoja
